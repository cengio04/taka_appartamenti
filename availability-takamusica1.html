<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Disponibilità Takámúsica 1 – Taká appartamenti</title>
  <meta name="description" content="Controlla la disponibilità reale di Takámúsica 1 a Cisterna d’Asti e invia una richiesta su WhatsApp.">
  <link rel="canonical" href="https://cengio04.github.io/taka_appartamenti/availability-takamusica1.html">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <a class="skip-link" href="#main">Salta al contenuto</a>

  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="logo" aria-label="Homepage Taká appartamenti">Taká appartamenti</a>
      <nav class="nav" aria-label="Principale">
        <ul class="nav-menu">
          <li><a href="index.html#appartamenti">Appartamenti</a></li>
          <li><a href="index.html#servizi">Servizi</a></li>
          <li><a href="index.html#dove-siamo">Dove siamo</a></li>
          <li><a href="index.html#contatti">Contatti</a></li>
          <li><a class="btn btn-primary" href="https://wa.me/393667273951" target="_blank" rel="noopener">Prenota ora</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main id="main">
    <section class="section">
      <div class="container">
        <h1>Disponibilità – Takámúsica 1</h1>

        <div class="availability-head">
          <div>
            <div class="small muted">Appartamento</div>
            <strong>Takámúsica 1</strong> <span class="small muted">(max 4 ospiti)</span>
          </div>

          <label class="guest-select" style="margin-left:auto;">
            <span>Ospiti</span>
            <input id="guests" type="number" min="1" max="4" value="2" inputmode="numeric">
          </label>

          <div class="legend" style="width:100%;">
            <span class="lg lg-free">Disponibile</span>
            <span class="lg lg-busy">Occupato</span>
            <span class="lg lg-sel">Selezionato</span>
          </div>
        </div>

        <div id="calendar" class="calendar-wrap"></div>

        <div id="selBox" class="selection-box">
          <p>Seleziona check‑in (prima data) e check‑out (seconda data). Fonte calendario: Airbnb sincronizzato (aggiornamento periodico).</p>
          <div id="selInfo"></div>
          <button id="askBtn" class="btn btn-primary" disabled>Richiedi prenotazione su WhatsApp</button>
          <p class="small muted" id="updNote"></p>
        </div>

        <p class="small"><a href="availability-takamusica2.html">Vuoi vedere Takámúsica 2?</a></p>
      </div>
    </section>
  </main>

  <script>
  const WORKER_BASE = "taka-ics.lorenzodibilio04.workers.dev"; // <- inserisci l'URL del Worker
  const APT = { key: "takamusica1", name: "Takámúsica 1", max: 4, phone: "393667273951" };
  const MONTHS_TO_SHOW = 6;

  const $ = s => document.querySelector(s);
  const calendarEl = $("#calendar");
  const guestsInput= $("#guests");
  const askBtn     = $("#askBtn");
  const selInfo    = $("#selInfo");
  const updNote    = $("#updNote");

  let occupiedSet   = new Set();
  let selectedStart = null;
  let selectedEnd   = null;
  let updatedAt     = null;

  guestsInput.addEventListener("change", ()=> {
    if (+guestsInput.value < 1) guestsInput.value = 1;
    if (+guestsInput.value > APT.max) guestsInput.value = APT.max;
  });

  askBtn.addEventListener("click", ()=>{
    if(!selectedStart || !selectedEnd) return;
    const guests = guestsInput.value;
    const nights = diffNights(selectedStart, selectedEnd);
    const msg = `Ciao, vorrei prenotare ${APT.name} dal ${fmtIT(selectedStart)} al ${fmtIT(selectedEnd)} per ${guests} persone (${nights} notti).`;
    const wa = new URL(`https://wa.me/${APT.phone}`);
    wa.searchParams.set("text", msg);
    window.open(wa.toString(), "_blank");
  });

  function fmtIT(iso){ return new Date(iso).toLocaleDateString("it-IT"); }
  function diffNights(a,b){ return Math.max( (new Date(b)-new Date(a))/(1000*60*60*24), 0 ); }

  function monthDays(y,m){
    const out=[]; const d=new Date(Date.UTC(y,m,1));
    while(d.getUTCMonth()===m){ out.push(new Date(d)); d.setUTCDate(d.getUTCDate()+1); }
    return out;
  }

  function renderCalendar(){
    calendarEl.innerHTML="";
    const now=new Date();
    for(let k=0;k<MONTHS_TO_SHOW;k++){
      const d=new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth()+k, 1));
      const y=d.getUTCFullYear(), m=d.getUTCMonth();
      const days=monthDays(y,m);
      const block=document.createElement("div");
      block.className="month-block";
      const title=d.toLocaleDateString("it-IT",{month:"long", year:"numeric"});
      block.innerHTML=`<h2>${title}</h2><div class="month-grid"></div>`;
      const grid=block.querySelector(".month-grid");
      const startW=(new Date(Date.UTC(y,m,1)).getUTCDay()+6)%7;
      for(let i=0;i<startW;i++){ const e=document.createElement("div"); e.className="day empty"; grid.appendChild(e); }
      days.forEach(day=>{
        const iso=day.toISOString().slice(0,10);
        const btn=document.createElement("button");
        btn.type="button"; btn.className="day"; btn.dataset.date=iso; btn.textContent=day.getUTCDate();
        if(occupiedSet.has(iso)){ btn.classList.add("busy"); btn.disabled=true; }
        else { btn.addEventListener("click", ()=>onDayClick(iso)); }
        grid.appendChild(btn);
      });
      calendarEl.appendChild(block);
    }
    renderSelection();
  }

  function onDayClick(iso){
    if(!selectedStart){ selectedStart=iso; selectedEnd=null; }
    else if(!selectedEnd){
      if(iso<=selectedStart){ selectedStart=iso; selectedEnd=null; }
      else{
        if(!rangeIsFree(selectedStart, iso)){
          alert("Il range selezionato include giorni occupati.");
          return;
        }
        selectedEnd=iso;
      }
    } else {
      selectedStart=iso; selectedEnd=null;
    }
    renderSelection();
  }

  function rangeIsFree(a,b){
    const d=new Date(a), e=new Date(b);
    while(d<e){
      const iso=d.toISOString().slice(0,10);
      if(occupiedSet.has(iso)) return false;
      d.setUTCDate(d.getUTCDate()+1);
    }
    return true;
  }

  function renderSelection(){
    document.querySelectorAll(".day.sel-start,.day.sel-range").forEach(el=>{
      el.classList.remove("sel-start","sel-range");
    });
    if(selectedStart){
      const startBtn=document.querySelector(`.day[data-date="${selectedStart}"]`);
      if(startBtn) startBtn.classList.add("sel-start");
    }
    if(selectedStart && selectedEnd){
      const s=new Date(selectedStart), e=new Date(selectedEnd);
      document.querySelectorAll(".day").forEach(b=>{
        const d=new Date(b.dataset.date);
        if(d>s && d<e) b.classList.add("sel-range");
      });
      const n=diffNights(selectedStart, selectedEnd);
      selInfo.innerHTML=`<p><strong>${n} notti</strong> dal ${fmtIT(selectedStart)} al ${fmtIT(selectedEnd)}</p>`;
      askBtn.disabled=false;
    } else {
      selInfo.innerHTML=""; askBtn.disabled=true;
    }
    updNote.textContent = updatedAt ? `Ultimo aggiornamento: ${new Date(updatedAt).toLocaleString("it-IT")}` : "";
    if (+guestsInput.value > APT.max) guestsInput.value = APT.max;
  }

  async function loadAvailability(){
    try{
      const res=await fetch(`${WORKER_BASE}/availability/${APT.key}`);
      const data=await res.json();
      occupiedSet=new Set(data.occupied||[]);
      updatedAt=data.updatedAt||null;
    }catch(e){
      occupiedSet=new Set(); updatedAt=null;
      alert("Non riesco a caricare la disponibilità. Riprova più tardi.");
    }
    renderCalendar();
  }

  loadAvailability();
  </script>
</body>
</html>
