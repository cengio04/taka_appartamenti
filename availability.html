<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Disponibilità appartamenti – Taká appartamenti</title>
  <meta name="description" content="Verifica disponibilità reale e invia una richiesta su WhatsApp. Seleziona check‑in e check‑out mese per mese.">
  <link rel="canonical" href="https://cengio04.github.io/taka_appartamenti/availability.html">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="page-availability">
  <a class="skip-link" href="#main">Salta al contenuto</a>

  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="logo" aria-label="Homepage Taká appartamenti">Taká appartamenti</a>
      <nav class="nav" aria-label="Principale">
        <ul class="nav-menu">
          <li><a href="index.html#appartamenti">Appartamenti</a></li>
          <li><a href="index.html#servizi">Servizi</a></li>
          <li><a href="index.html#dove-siamo">Dove siamo</a></li>
          <li><a href="index.html#contatti">Contatti</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main id="main">
    <section class="section availability">
      <div class="container">
        <h1>Disponibilità</h1>

        <div class="availability-head">
          <label class="apt-select">
            <span>Appartamento</span>
            <select id="apt">
              <option value="takamusica1">Takámúsica 1 (max 4)</option>
              <option value="takamusica2">Takámúsica 2 (max 5)</option>
              <option value="takapradalu">Takápradalù (max 5)</option>
              <option value="takalcastel">Takálcastel (max 3)</option>
            </select>
          </label>

          <label class="guest-select">
            <span>Ospiti</span>
            <input id="guests" type="number" min="1" value="2" inputmode="numeric">
          </label>

          <div class="legend">
            <span class="lg lg-free">Disponibile</span>
            <span class="lg lg-busy">Occupato</span>
            <span class="lg lg-end">Check‑out</span>
          </div>
        </div>

        <!-- Navigazione mese -->
        <div class="cal-nav">
          <button id="prevMonth" class="nav-btn" aria-label="Mese precedente">‹</button>
          <div id="monthLabel" class="month-label" aria-live="polite"></div>
          <button id="nextMonth" class="nav-btn" aria-label="Mese successivo">›</button>
        </div>

        <!-- Intestazione giorni settimana -->
        <div class="weekdays" aria-hidden="true">
          <div>Lu</div><div>Ma</div><div>Me</div><div>Gi</div><div>Ve</div><div>Sa</div><div>Do</div>
        </div>

        <!-- Calendario del mese corrente -->
        <div id="grid" class="month-grid" role="grid" aria-label="Calendario"></div>

        <div id="selBox" class="selection-box">
          <p>Primo click = <strong>check‑in</strong>, secondo click = <strong>check‑out</strong>. Clicca di nuovo il check‑in per deselezionarlo. I giorni passati sono grigi.</p>
          <div id="selInfo"></div>
          <button id="askBtn" class="btn btn-primary" disabled>Richiedi prenotazione su WhatsApp</button>
          <p class="small muted" id="updNote"></p>
        </div>
      </div>
    </section>
  </main>

  <script>
  // URL del tuo Worker
  const WORKER_BASE = "https://taka-ics.lorenzodibilio04.workers.dev";

  // Appartamenti: nome, max ospiti, telefono WhatsApp
  const APTS = {
    takamusica1: { name: "Takámúsica 1", max: 4, phone: "393667273951" },
    takamusica2: { name: "Takámúsica 2", max: 5, phone: "393667273951" },
    takapradalu:{ name: "Takápradalù",  max: 5, phone: "393667273951" },
    takalcastel:{ name: "Takálcastel",  max: 3, phone: "393667273951" }
  };

  const $ = s => document.querySelector(s);
  const gridEl      = $("#grid");
  const aptSel      = $("#apt");
  const guestsInput = $("#guests");
  const askBtn      = $("#askBtn");
  const selInfo     = $("#selInfo");
  const updNote     = $("#updNote");
  const monthLabel  = $("#monthLabel");
  const prevBtn     = $("#prevMonth");
  const nextBtn     = $("#nextMonth");

  // Pre-selezione da query string (?apt=…)
  const url = new URL(location.href);
  const aptParam = url.searchParams.get("apt");
  if (aptParam && APTS[aptParam]) aptSel.value = aptParam;

  // Stato globale
  let occupiedSet   = new Set(); // date occupate YYYY-MM-DD
  let selectedStart = null;      // check-in (ISO)
  let selectedEnd   = null;      // check-out (ISO)
  let updatedAt     = null;      // timestamp feed
  let viewMonth     = firstOfMonthUTC(new Date()); // mese mostrato

  // Oggi (mezzanotte UTC) per marcare giorni passati
  const TODAY_ISO = (() => {
    const now = new Date();
    const utcMid = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
    return utcMid.toISOString().slice(0,10);
  })();

  function firstOfMonthUTC(d) { return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1)); }
  function addMonthsUTC(d, delta) { return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth() + delta, 1)); }
  function fmtIT(iso){ return new Date(iso).toLocaleDateString("it-IT"); }
  function diffNights(a,b){ return Math.max( (new Date(b)-new Date(a))/(1000*60*60*24), 0 ); }
  function isoYMD(d){ return d.toISOString().slice(0,10); }

  function syncGuestMax(){
    const a = aptSel.value;
    guestsInput.max = APTS[a].max;
    if (+guestsInput.value < 1) guestsInput.value = 1;
    if (+guestsInput.value > APTS[a].max) guestsInput.value = APTS[a].max;
  }
  syncGuestMax();
  guestsInput.addEventListener("change", syncGuestMax);

  aptSel.addEventListener("change", ()=>{
    syncGuestMax();
    selectedStart = selectedEnd = null;
    viewMonth = firstOfMonthUTC(new Date());
    renderMonth();
    loadAvailability();
    const u = new URL(location.href);
    u.searchParams.set("apt", aptSel.value);
    history.replaceState({}, "", u);
  });

  prevBtn.addEventListener("click", ()=>{ viewMonth = addMonthsUTC(viewMonth, -1); renderMonth(); });
  nextBtn.addEventListener("click", ()=>{ viewMonth = addMonthsUTC(viewMonth, +1); renderMonth(); });

  askBtn.addEventListener("click", ()=>{
    if(!selectedStart || !selectedEnd) return;
    const aptKey = aptSel.value;
    const phone  = APTS[aptKey].phone;
    const name   = APTS[aptKey].name;
    const guests = guestsInput.value;
    const nights = diffNights(selectedStart, selectedEnd);
    const msg = `Ciao, vorrei prenotare ${name} dal ${fmtIT(selectedStart)} al ${fmtIT(selectedEnd)} per ${guests} persone (${nights} notti).`;
    const wa = new URL(`https://wa.me/${phone}`);
    wa.searchParams.set("text", msg);
    window.open(wa.toString(), "_blank");
  });

  function monthDaysUTC(y,m){
    const out=[]; const d=new Date(Date.UTC(y,m,1));
    while(d.getUTCMonth()===m){ out.push(new Date(d)); d.setUTCDate(d.getUTCDate()+1); }
    return out;
  }

  function renderMonth(){
    // Invalida selezioni nel passato
    if (selectedStart && selectedStart < TODAY_ISO) { selectedStart = null; selectedEnd = null; }
    if (selectedEnd && selectedEnd < TODAY_ISO) { selectedEnd = null; }

    monthLabel.textContent = viewMonth.toLocaleDateString("it-IT",{ month:"long", year:"numeric" });
    gridEl.innerHTML = "";
    const y = viewMonth.getUTCFullYear();
    const m = viewMonth.getUTCMonth();
    const days = monthDaysUTC(y,m);
    const startW = (new Date(Date.UTC(y,m,1)).getUTCDay()+6)%7; // lun=0

    // celle vuote prima del 1°
    for(let i=0;i<startW;i++){
      const empty = document.createElement("div");
      empty.className = "day empty";
      gridEl.appendChild(empty);
    }

    // giorni del mese
    days.forEach(day=>{
      const iso = isoYMD(day);
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "day";
      btn.dataset.date = iso;
      btn.textContent = day.getUTCDate();

      const isPast = iso < TODAY_ISO;
      if (isPast) {
        btn.classList.add("past");
        btn.disabled = true;
      } else if (occupiedSet.has(iso)){
        btn.classList.add("busy");
        btn.disabled = true;
      } else {
        btn.addEventListener("click", ()=> onDayClick(iso));
      }

      // evidenziazione selezione
      if(selectedStart === iso){ btn.classList.add("sel-start"); }
      if(selectedStart && selectedEnd){
        const d = new Date(iso);
        if(d > new Date(selectedStart) && d < new Date(selectedEnd)){
          btn.classList.add("sel-range");      // giorni interni (verde)
        }
        if(iso === selectedEnd){
          btn.classList.add("sel-end");        // check-out (azzurro)
        }
      }

      gridEl.appendChild(btn);
    });

    updNote.textContent = updatedAt ? `Ultimo aggiornamento: ${new Date(updatedAt).toLocaleString("it-IT")}` : "";
    renderSelectionInfo();
  }

  function onDayClick(iso){
    // Deseleziona se riclicchi il check-in (senza check-out)
    if(selectedStart && !selectedEnd && iso === selectedStart){
      selectedStart = null;
      selectedEnd   = null;
      renderMonth();
      return;
    }
    // Reset se riclicchi il check-in quando hai già un intervallo completo
    if(selectedStart && selectedEnd && iso === selectedStart){
      selectedStart = null;
      selectedEnd   = null;
      renderMonth();
      return;
    }
    // Primo click: imposta check-in
    if(!selectedStart){
      selectedStart = iso;
      selectedEnd   = null;
      renderMonth();
      return;
    }
    // Secondo click: imposta check-out (dopo e senza giorni occupati in mezzo)
    if(!selectedEnd){
      if(iso <= selectedStart){
        selectedStart = iso;
        selectedEnd   = null;
        renderMonth();
        return;
      }
      if(!rangeIsFree(selectedStart, iso)){
        alert("Il periodo selezionato include giorni occupati. Scegli un intervallo diverso.");
        return;
      }
      selectedEnd = iso;
      renderMonth();
      return;
    }
    // Terzo click: nuova selezione
    selectedStart = iso;
    selectedEnd   = null;
    renderMonth();
  }

  function rangeIsFree(aISO, bISO){
    const a = new Date(aISO);
    const b = new Date(bISO);
    const d = new Date(a);
    while(d < b){ // il giorno di check-out è escluso
      const iso = isoYMD(d);
      if(occupiedSet.has(iso)) return false;
      d.setUTCDate(d.getUTCDate()+1);
    }
    return true;
  }

  function renderSelectionInfo(){
    if(selectedStart && selectedEnd){
      const n = diffNights(selectedStart, selectedEnd);
      selInfo.innerHTML = `<p>Check‑in: <strong>${fmtIT(selectedStart)}</strong> · Check‑out: <strong>${fmtIT(selectedEnd)}</strong> · <strong>${n} notti</strong></p>`;
      askBtn.disabled = false;
    } else if(selectedStart){
      selInfo.innerHTML = `<p>Check‑in: <strong>${fmtIT(selectedStart)}</strong> · Seleziona il check‑out o riclicca per annullare</p>`;
      askBtn.disabled = true;
    } else {
      selInfo.innerHTML = "";
      askBtn.disabled = true;
    }
    syncGuestMax();
  }

  async function loadAvailability(){
    const apt = aptSel.value;
    try{
      const res  = await fetch(`${WORKER_BASE}/availability/${apt}`);
      const data = await res.json();
      occupiedSet = new Set(data.occupied || []);
      updatedAt   = data.updatedAt || null;
    }catch(e){
      occupiedSet = new Set();
      updatedAt   = null;
      alert("Non riesco a caricare la disponibilità. Riprova più tardi.");
    }
    renderMonth();
  }

  // Avvio
  loadAvailability();
  </script>
</body>
</html>
